<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Motivación del día</title>
  <style>
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color:#fff;
    }
    .card{
      width:min(760px, 92vw);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      padding: 28px 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      text-align:center;
    }
    h1{ font-size: 22px; margin: 0 0 10px; opacity:.9; }
    .date{ font-size: 14px; opacity:.75; margin-bottom: 14px; }
    .quote{ font-size: 26px; line-height:1.25; font-weight: 650; margin: 0; }
    .small{ margin-top:14px; font-size: 13px; opacity:.75; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Motivación del día</h1>
    <div class="date" id="date"></div>
    <p class="quote" id="quote">Cargando...</p>
    <p class="small" id="meta"></p>
  </div>

  <script>
    const SHEETS_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIeSLoGa--GmKVbgTW_c_KfKD-qbA-ySD_RQMPVlwrACZmIWENC1X0foqJJaVHmgwVtsMHkWdnhHAd/pub?output=csv";

    const quoteEl = document.getElementById("quote");
    const dateEl  = document.getElementById("date");
    const metaEl  = document.getElementById("meta");

    function formatDateHuman(d){
      return d.toLocaleDateString("es-ES", {
        weekday:"long", year:"numeric", month:"long", day:"numeric"
      });
    }

    function formatDateKey(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Parser CSV simple para 2 columnas: fecha,mensaje
    // Soporta mensajes con comas (porque reconstruye todo lo que venga después de la fecha).
    function parseCsvRows(csvText){
      const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (lines.length <= 1) return [];

      const rows = [];
      for (const line of lines.slice(1)) { // saltar header
        const parts = line.split(",");
        const fecha = (parts[0] || "").trim().replace(/^"|"$/g, "");
        let mensaje = parts.slice(1).join(",").trim();

        if (mensaje.startsWith('"') && mensaje.endsWith('"')) {
          mensaje = mensaje.slice(1, -1).replace(/""/g, '"');
        }

        if (fecha && mensaje) rows.push({ fecha, mensaje });
      }
      return rows;
    }

    async function loadMessageByDate(){
      const today = new Date();
      const todayKey = formatDateKey(today);

      dateEl.textContent = formatDateHuman(today);
      metaEl.textContent = "";

      try {
        const res = await fetch(SHEETS_CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("No se pudo cargar el CSV");
        const csv = await res.text();

        const rows = parseCsvRows(csv);

        if (!rows.length) {
          quoteEl.textContent = "Tu Sheet está vacío o no tiene las columnas fecha/mensaje.";
          return;
        }

        // 1) Buscar frase exacta para hoy
        const exact = rows.find(r => r.fecha === todayKey);
        if (exact) {
          quoteEl.textContent = exact.mensaje;
          metaEl.textContent = `Programada para hoy (${todayKey}).`;
          return;
        }

        // 2) Si no hay para hoy, buscar próxima futura
        const future = rows
          .map(r => ({ ...r, dateObj: new Date(r.fecha + "T00:00:00") }))
          .filter(r => !isNaN(r.dateObj) && r.dateObj > today)
          .sort((a,b) => a.dateObj - b.dateObj)[0];

        if (future) {
          quoteEl.textContent = "Hoy no hay frase programada.";
          metaEl.textContent = `Próxima: ${future.fecha} → ${future.mensaje}`;
        } else {
          quoteEl.textContent = "Hoy no hay frase programada.";
          metaEl.textContent = "Agrega nuevas filas con fechas futuras (YYYY-MM-DD).";
        }

      } catch (err) {
        quoteEl.textContent =
          "Error cargando frases. Revisa que el Sheet esté 'Publicado en la web' como CSV.";
        console.error(err);
      }
    }

    loadMessageByDate();
  </script>
</body>
</html>
